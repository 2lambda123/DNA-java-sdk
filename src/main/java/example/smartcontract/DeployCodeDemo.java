/*
 * Copyright (C) 2018 The DNA Authors
 * This file is part of The DNA library.
 *
 *  The DNA is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU Lesser General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  The DNA is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU Lesser General Public License for more details.
 *
 *  You should have received a copy of the GNU Lesser General Public License
 *  along with The DNA.  If not, see <http://www.gnu.org/licenses/>.
 *
 */
package example.smartcontract;

import com.github.DNAProject.account.Account;
import com.github.DNAProject.common.Address;
import com.github.DNAProject.common.Helper;
import com.github.DNAProject.core.payload.DeployCode;
import com.github.DNAProject.core.transaction.Transaction;
import com.github.DNAProject.DnaSdk;
import com.github.DNAProject.crypto.SignatureScheme;


/**
 *
 */
public class DeployCodeDemo {
    public static void main(String[] args) {
        try {
            DnaSdk dnaSdk = getDnaSdk();

//            InputStream is = new FileInputStream("/Users/sss/dev/test/IdContract/IdContract.avm");//IdContract
//            byte[] bys = new byte[is.available()];
//            is.read(bys);
//            is.close();
            //code = Helper.toHexString(bys);
//            System.out.println("Code:" + Helper.toHexString(bys));

            String password = "111111";
            String privatekey0 = "59e68b0cc387dd4e36e50c0562ff589f1d9289d32fc694b8918a3859faba6c67";
            String privatekey1 = "523c5fcf74823831756f0bcb3634234f10b3beb1c05595058534577752ad2d9f";
            Account acct0 = new Account(Helper.hexToBytes(privatekey0), dnaSdk.defaultSignScheme);
            String code = "";
            code = "0114c56b05322e302e306a00527ac4681953797374656d2e53746f726167652e476574436f6e746578746a51527ac404544553546a52527ac404544553546a53527ac4586a54527ac40400e1f5056a55527ac422414e4835624872727431313158774e456e75505a6a3675393544643675374734443668204f6e746f6c6f67792e52756e74696d652e426173653538546f416464726573736a56527ac40500ac23fc066a57527ac401016a58527ac401026a59527ac401036a5a527ac40b546f74616c537570706c796a5b527ac40d5061757365436f6e74726163746a5c527ac4054f776e65726a5d527ac46c0137c56b6a00527ac46a51527ac46a52527ac46a51c304696e69747d9c7c75641500006a00c306ad05000000006e6c75666203006a51c3046e616d657d9c7c75641500006a00c3062107000000006e6c75666203006a51c30673796d626f6c7d9c7c75641500006a00c3063907000000006e6c75666203006a51c308646563696d616c737d9c7c75641500006a00c3065107000000006e6c75666203006a51c30b746f74616c537570706c797d9c7c75641500006a00c3066907000000006e6c75666203006a51c30962616c616e63654f667d9c7c756435006a52c3c0517d9e7c75640a00006c75666203006a52c300c36a54527ac46a54c3516a00c3069a07000000006e6c75666203006a51c3087472616e736665727d9c7c75644f006a52c3c0537d9e7c75640a00006c75666239006a52c300c36a55527ac46a52c351c36a56527ac46a52c352c36a57527ac46a57c36a56c36a55c3536a00c3060008000000006e6c75666203006a51c30d7472616e736665724d756c74697d9c7c756418006a52c3516a00c306160a000000006e6c75666203006a51c30c7472616e7366657246726f6d7d9c7c75645c006a52c3c0547d9e7c75640a00006c75666203006a52c300c36a58527ac46a52c351c36a55527ac46a52c352c36a56527ac46a52c353c36a57527ac46a57c36a56c36a55c36a58c3546a00c306f20b000000006e6c75666203006a51c307617070726f76657d9c7c75644f006a52c3c0537d9e7c75640a00006c75666203006a52c300c36a59527ac46a52c351c36a58527ac46a52c352c36a57527ac46a57c36a58c36a59c3536a00c306d20a000000006e6c75666203006a51c309616c6c6f77616e63657d9c7c756442006a52c3c0527d9e7c75640a00006c75666203006a52c300c36a59527ac46a52c351c36a58527ac46a58c36a59c3526a00c306b00e000000006e6c75666203006a51c3056f776e65727d9c7c75641500006a00c306fb0e000000006e6c75666203006a51c30769734f776e65727d9c7c756435006a52c3c0517d9e7c75640a00006c75666203006a52c300c36a54527ac46a54c3516a00c3062c0f000000006e6c75666203006a51c3117472616e736665724f776e6572736869707d9c7c756435006a52c3c0517d9e7c75640a00006c75666203006a52c300c36a54527ac46a54c3516a00c306770f000000006e6c75666203006a51c30570617573657d9c7c75641500006a00c306ce10000000006e6c75666203006a51c307756e70617573657d9c7c75641500006a00c3064111000000006e6c75666203006a51c3097669657750617573657d9c7c75641500006a00c306b411000000006e6c75666203006a51c30d667265657a654163636f756e747d9c7c756435006a52c3c0517d9e7c75640a00006c75666203006a52c300c36a54527ac46a54c3516a00c306a512000000006e6c75666203006a51c30f756e667265657a654163636f756e747d9c7c756435006a52c3c0517d9e7c75640a00006c75666203006a52c300c36a54527ac46a54c3516a00c3065013000000006e6c75666203006a51c31176696577467265657a654163636f756e747d9c7c756435006a52c3c0517d9e7c75640a00006c75666203006a52c300c36a54527ac46a54c3516a00c306fb13000000006e6c7566620300006c75665ac56b6a00527ac46a51527ac46203000e4f776e657220696c6c6567616c216a00c356c3c001147d9c7c75526a00c306a210000000006e756a00c356c36a00c35dc36a00c351c3681253797374656d2e53746f726167652e5075746a00c35dc36a00c351c3681253797374656d2e53746f726167652e4765746a53527ac413416c726561647920696e697469616c697a65646a00c35bc36a00c351c3681253797374656d2e53746f726167652e476574007d9c7c75526a00c306a210000000006e756a00c357c36a00c355c3956a54527ac46a54c36a00c35bc36a00c351c3681253797374656d2e53746f726167652e5075746a54c36a00c358c36a53c37e6a00c351c3681253797374656d2e53746f726167652e5075746a54c36a53c300087472616e7366657254c1681553797374656d2e52756e74696d652e4e6f746966796a53c300117472616e736665724f776e65727368697053c1681553797374656d2e52756e74696d652e4e6f74696679516c756655c56b6a00527ac46a51527ac46203006a00c352c36c756655c56b6a00527ac46a51527ac46203006a00c353c36c756655c56b6a00527ac46a51527ac46203006a00c354c36c756655c56b6a00527ac46a51527ac46203006a00c35bc36a00c351c3681253797374656d2e53746f726167652e4765746c756658c56b6a00527ac46a51527ac46a52527ac46203001461646472657373206c656e677468206572726f726a52c3c001147d9c7c75526a00c306a210000000006e756a00c358c36a52c37e6a00c351c3681253797374656d2e53746f726167652e4765746c75665ec56b6a00527ac46a51527ac46a52527ac46a53527ac46a54527ac46203001461646472657373206c656e677468206572726f726a53c3c001147d9c7c7576640e00756a52c3c001147d9c7c75526a00c306a210000000006e750f496e76616c696420696e766f6b65726a52c3681b53797374656d2e52756e74696d652e436865636b5769746e657373517d9c7c75526a00c306a210000000006e750e496e76616c696420416d6f756e746a54c3007da07c75526a00c306a210000000006e75006a00c306e511000000006e6a52c3516a00c3063514000000006e6a53c3516a00c3063514000000006e6a00c358c36a52c37e6a56527ac46a56c36a00c351c3681253797374656d2e53746f726167652e4765746a57527ac4124e6f7420656e6f7567682062616c616e63656a54c36a57c37da17c75526a00c306a210000000006e756a54c36a57c37d9c7c756425006a56c36a00c351c3681553797374656d2e53746f726167652e44656c6574656226006a57c36a54c3946a56c36a00c351c3681253797374656d2e53746f726167652e5075746a00c358c36a53c37e6a58527ac46a58c36a00c351c3681253797374656d2e53746f726167652e4765746a59527ac46a59c36a54c3936a58c36a00c351c3681253797374656d2e53746f726167652e5075746a54c36a53c36a52c3087472616e7366657254c1681553797374656d2e52756e74696d652e4e6f74696679516c75665bc56b6a00527ac46a51527ac46a52527ac4620300006a53527ac46a52c36a54527ac46a54c3c06a55527ac46a53c36a55c39f6485006a54c36a53c3c36a56527ac46a53c351936a53527ac46a56c3c0537d9e7c756423001b7472616e736665724d756c746920706172616d73206572726f722ef0620300147472616e736665724d756c7469206661696c65646a56c352c36a56c351c36a56c300c3536a00c3060008000000006e526a00c306a210000000006e756277ff516c75665cc56b6a00527ac46a51527ac46a52527ac46a53527ac46a54527ac46203001461646472657373206c656e677468206572726f726a53c3c001147d9c7c7576640e00756a52c3c001147d9c7c75526a00c306a210000000006e750f496e76616c696420696e766f6b65726a52c3681b53797374656d2e52756e74696d652e436865636b5769746e657373517d9c7c75526a00c306a210000000006e750e496e76616c696420616d6f756e746a54c3007da07c75526a00c306a210000000006e756a00c359c36a52c37e6a53c37e6a56527ac46a54c36a56c36a00c351c3681253797374656d2e53746f726167652e5075746a54c36a53c36a52c308617070726f76616c54c1681553797374656d2e52756e74696d652e4e6f74696679516c75660112c56b6a00527ac46a51527ac46a52527ac46a53527ac46a54527ac46a55527ac46203001461646472657373206c656e677468206572726f726a52c3c001147d9c7c7576641d00756a53c3c001147d9c7c7576640e00756a54c3c001147d9c7c75526a00c306a210000000006e750f496e76616c696420696e766f6b65726a52c3681b53797374656d2e52756e74696d652e436865636b5769746e657373517d9c7c75526a00c306a210000000006e75006a00c306e511000000006e6a52c3516a00c3063514000000006e6a53c3516a00c3063514000000006e6a54c3516a00c3063514000000006e6a00c358c36a53c37e6a57527ac46a57c36a00c351c3681253797374656d2e53746f726167652e4765746a58527ac40e496e76616c696420616d6f756e746a55c36a58c37da17c7576640c00756a55c3007da07c75526a00c306a210000000006e756a00c359c36a53c37e6a52c37e6a59527ac46a59c36a00c351c3681253797374656d2e53746f726167652e4765746a5a527ac46a00c358c36a54c37e6a5b527ac40e496e76616c696420616d6f756e746a55c36a5ac37da17c75526a00c306a210000000006e756a55c36a5ac37d9c7c756448006a59c36a00c351c3681553797374656d2e53746f726167652e44656c6574656a58c36a55c3946a57c36a00c351c3681253797374656d2e53746f726167652e5075746249006a5ac36a55c3946a59c36a00c351c3681253797374656d2e53746f726167652e5075746a58c36a55c3946a57c36a00c351c3681253797374656d2e53746f726167652e5075746a5bc36a00c351c3681253797374656d2e53746f726167652e4765746a5c527ac46a5cc36a55c3936a5bc36a00c351c3681253797374656d2e53746f726167652e5075746a55c36a54c36a53c3087472616e7366657254c1681553797374656d2e52756e74696d652e4e6f74696679516c756659c56b6a00527ac46a51527ac46a52527ac46a53527ac46203006a00c359c36a52c37e6a53c37e6a54527ac46a54c36a00c351c3681253797374656d2e53746f726167652e4765746c756655c56b6a00527ac46a51527ac46203006a00c35dc36a00c351c3681253797374656d2e53746f726167652e4765746c756657c56b6a00527ac46a51527ac46a52527ac46203006a00c35dc36a00c351c3681253797374656d2e53746f726167652e4765746a52c37d9c7c75640a00516c7566620700006c75666c756658c56b6a00527ac46a51527ac46a52527ac4620300006a00c3063d10000000006e1461646472657373206c656e677468206572726f726a52c3c001147d9c7c75526a00c306a210000000006e756a00c35dc36a00c351c3681253797374656d2e53746f726167652e4765746a54527ac46a52c36a00c35dc36a00c351c3681253797374656d2e53746f726167652e5075746a52c36a54c3117472616e736665724f776e65727368697053c1681553797374656d2e52756e74696d652e4e6f74696679516c756656c56b6a00527ac46a51527ac4620300094e6f74204f776e65726a00c35dc36a00c351c3681253797374656d2e53746f726167652e476574681b53797374656d2e52756e74696d652e436865636b5769746e657373526a00c306a210000000006e756c756657c56b6a00527ac46a51527ac46a52527ac46a53527ac46203006a52c391640a006a53c3f0620300516c756655c56b6a00527ac46a51527ac4620300006a00c3063d10000000006e006a00c306e511000000006e516a00c35cc36a00c351c3681253797374656d2e53746f726167652e507574510d636f6e7472616374506175736552c1681553797374656d2e52756e74696d652e4e6f74696679516c756655c56b6a00527ac46a51527ac4620300006a00c3063d10000000006e006a00c3064412000000006e006a00c35cc36a00c351c3681253797374656d2e53746f726167652e507574000d636f6e7472616374506175736552c1681553797374656d2e52756e74696d652e4e6f74696679516c756655c56b6a00527ac46a51527ac46203006a00c35cc36a00c351c3681253797374656d2e53746f726167652e4765746c756655c56b6a00527ac46a51527ac46203001b4e6f74207061757365207374617465206f6620436f6e74726163746a00c35cc36a00c351c3681253797374656d2e53746f726167652e476574007d9c7c75526a00c306a210000000006e756c756655c56b6a00527ac46a51527ac46203001d4e6f7420756e7061757365207374617465206f6620436f6e74726163746a00c35cc36a00c351c3681253797374656d2e53746f726167652e476574517d9c7c75526a00c306a210000000006e756c756658c56b6a00527ac46a51527ac46a52527ac4620300006a00c3063d10000000006e6a52c3516a00c3063514000000006e1461646472657373206c656e677468206572726f726a52c3c001147d9c7c75526a00c306a210000000006e75516a00c35ac36a52c37e6a00c351c3681253797374656d2e53746f726167652e507574516a52c30a75736572467265657a6553c1681553797374656d2e52756e74696d652e4e6f74696679516c756658c56b6a00527ac46a51527ac46a52527ac4620300006a00c3063d10000000006e6a52c3516a00c3069f14000000006e1461646472657373206c656e677468206572726f726a52c3c001147d9c7c75526a00c306a210000000006e75006a00c35ac36a52c37e6a00c351c3681253797374656d2e53746f726167652e507574006a52c30a75736572467265657a6553c1681553797374656d2e52756e74696d652e4e6f74696679516c756657c56b6a00527ac46a51527ac46a52527ac46203006a00c35ac36a52c37e6a00c351c3681253797374656d2e53746f726167652e4765746c756657c56b6a00527ac46a51527ac46a52527ac46203001d4e6f7420756e66726f7a656e207374617465206f66206163636f756e746a00c35ac36a52c37e6a00c351c3681253797374656d2e53746f726167652e476574007d9c7c75526a00c306a210000000006e756c756657c56b6a00527ac46a51527ac46a52527ac46203001b4e6f742066726f7a656e207374617465206f66206163636f756e746a00c35ac36a52c37e6a00c351c3681253797374656d2e53746f726167652e476574517d9c7c75526a00c306a210000000006e756c7566";

            System.out.println("ContractAddress:" + Address.AddressFromVmCode(code).toHexString());
            if (true) {
                System.out.println(dnaSdk.getConnect().getContractJson(Address.AddressFromVmCode(code).toHexString()));
                System.exit(0);
            }
            System.out.println(acct0.getAddressU160().toBase58());
            dnaSdk.vm().setCodeAddress(Address.AddressFromVmCode(code).toHexString());
            Account account = new Account(Helper.hexToBytes(privatekey1),SignatureScheme.SHA256WITHECDSA);
            Transaction tx = dnaSdk.vm().makeDeployCodeTransaction(code, true, "name",
                    "v1.0", "author", "email", "desp", account.getAddressU160().toBase58(),dnaSdk.DEFAULT_DEPLOY_GAS_LIMIT,500);
            dnaSdk.signTx(tx, new Account[][]{{account}});
            String txHex = Helper.toHexString(tx.toArray());
            if(false){
                System.out.println(tx.hash().toString());
                Object result = dnaSdk.getConnect().syncSendRawTransaction(txHex);
                System.out.println(result);
                System.exit(0);
            }
            System.out.println(txHex);
           Object result = dnaSdk.getConnect().sendRawTransaction(txHex);
            System.out.println(result);

            System.out.println("txhash:" + tx.hash().toString());
            String txhash = tx.hash().toHexString();

            //System.out.println(dnaSdk.getConnect().getMemPoolTxCount());
            //System.out.println(dnaSdk.getConnect().getMemPoolTxState(txhash));
            Thread.sleep(6000);




            DeployCode t = (DeployCode) dnaSdk.getConnect().getTransaction(txhash);
            System.out.println(t.txType.value() & 0xff);
        } catch (Exception e) {

            e.printStackTrace();
        }
    }

    public static DnaSdk getDnaSdk() throws Exception {
        String ip = "http://127.0.0.1";
        String restUrl = ip + ":" + "20334";
        String rpcUrl = ip + ":" + "20336";
        String wsUrl = ip + ":" + "20335";

        DnaSdk wm = DnaSdk.getInstance();
        wm.setRpc(rpcUrl);
        wm.setRestful(restUrl);
        wm.setDefaultConnect(wm.getRestful());

        wm.openWalletFile("DeployDemo.json");

        return wm;
    }
}
